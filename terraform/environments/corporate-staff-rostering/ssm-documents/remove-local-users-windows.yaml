---
schemaVersion: "2.2"
description: "Powershell doc to remove all local users from Windows servers"
parameters:
  InstanceId:
    type: "String"
    description: "ID of the instance being targetted"
mainSteps:
  - name: RemoveLocalUsers
    action: "aws:runPowerShellScript"
    inputs:
      runCommand:
        - |
          # Fetch 'Developer' and 'Migration' local users
          $usersToRemove = @('Developer', 'Migration') # any other users to be removed can be added to this list

          # Remove each user
          foreach ($userToRemove in $usersToRemove) {
            $usersToRemove = $users | Where-Object { $_.Name -match '(?i)test\d+' -or $_.Name -match 'Test' -or $_.Name -match '(?i)user\d+' -and $_.Name -notin @('Administrator', 'Guest', 'DefaultAccount') }


            foreach ($user in $users) {
              $username = $user.Name
              Write-Output "Removing user: $username"
              net user $username /delete
            }
          }
