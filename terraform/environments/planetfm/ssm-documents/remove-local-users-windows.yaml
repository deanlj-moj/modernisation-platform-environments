---
schemaVersion: "2.2"
description:  "Powershell doc to remove all local users from Windows servers"
parameters:
  InstanceId:
    type: "String"
    description: "ID of the instance being targetted"
mainSteps:
  - name: RemoveLocalUsers
    action: "aws:runPowerShellScript"
    inputs:
      runCommand:
        - |
          # Fetch all local users except the default system accounts
          $users = Get-WmiObject -Class Win32_UserAccount -Filter "LocalAccount='True' AND Name='Migration' AND Name='Developer' AND Name<>'Administrator' AND Name<>'Guest' AND Name<>'DefaultAccount'"

          # Remove each user
          foreach ($user in $users) {
            $username = $user.Name
            Write-Output 'Removing user: $username'
            net user $username /delete
          }
    runbook: "Name: AWS-RunPowerShellScript"
    timeoutSeconds: 600
    onFailure: "Continue"
